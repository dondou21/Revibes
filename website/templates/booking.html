{% extends 'base.html' %}

{% block title %} Booking {% endblock %}

{% block body %}

<h2>Booking Form</h2>
<form action="" method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <table class="table table-dark table-hover">
        <thead>
            <tr>
                <th scope="col">Item Type</th>
                <th scope="col">Item Description</th>
                <th scope="col">Quantity</th>
                <th scope="col">Date of Appointment</th>
                <th scope="col">Time of Appointment</th>
                <th scope="col">Picture</th>
                <th scope="col">Location</th>
                <th scope="col">Add Booking</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ form.item_type }}</td>
                <td>{{ form.item_description }}</td>
                <td>{{ form.quantity }}</td>
                <td>{{ form.date_of_appointment }}</td>
                <td>{{ form.time_of_appointment }}</td>
                <td>{{ form.item_picture }}</td>
                <td>
                    <button type="button" onclick="getLocation()">Use Current Location</button>
                    <div id="map" style="height: 300px; width: 100%; margin-top: 10px;"></div>
                    {{ form.latitude }}
                    {{ form.longitude }}
                </td>
                <td>{{ form.submit }}</td>
            </tr>
        </tbody>
    </table>
</form>

<!-- Include Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    let map;
    let marker;

    function initMap() {
        const defaultLocation = { lat: -1.970579, lng: 30.104429 }; // Default to Kigali
        map = L.map('map').setView([defaultLocation.lat, defaultLocation.lng], 15);

        // Load and display tile layers from OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Add marker to the default location
        marker = L.marker([defaultLocation.lat, defaultLocation.lng], { draggable: true }).addTo(map);

        // Update form fields when marker is dragged
        marker.on('dragend', function (e) {
            const latLng = marker.getLatLng();
            document.getElementById('latitude').value = latLng.lat;
            document.getElementById('longitude').value = latLng.lng;
        });
    }

    // Get user's location
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // Center the map and move the marker to the user's location
                map.setView([lat, lng], 15);
                marker.setLatLng([lat, lng]);

                // Update form fields with the user's location
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
            }, function (error) {
                console.error('Error occurred. Error code: ' + error.code);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // Initialize the map on page load
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
    });
</script>

{% endblock %}
